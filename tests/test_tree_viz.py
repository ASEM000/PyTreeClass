from __future__ import annotations

import dataclasses

from jax import numpy as jnp

import pytreeclass as pytc
import pytreeclass.tree_viz as tree_viz


@pytc.treeclass
class Repr1:
    a: int = 1
    b: str = "string"
    c: float = 1.0
    d: tuple = "a" * 50
    e: list = None
    f: set = None
    g: dict = None
    h: jnp.ndarray = jnp.ones((5, 1))
    i: jnp.ndarray = jnp.ones((1, 6))
    j: jnp.ndarray = jnp.ones((1, 1, 4, 5))

    def __post_init__(self):
        self.e = [10] * 25
        self.f = {1, 2, 3}
        self.g = {"a": "a" * 50, "b": "b" * 50, "c": jnp.ones([5, 5])}


@pytc.treeclass
class Repr2:
    a: jnp.ndarray = jnp.ones((5, 1))
    b: jnp.ndarray = jnp.ones((1, 1))
    c: jnp.ndarray = jnp.ones((1, 1, 4, 5))


@pytc.treeclass
class Linear:
    weight: jnp.ndarray
    bias: jnp.ndarray
    notes: str = pytc.field(nondiff=True, default=("string"))

    def __init__(self, in_dim, out_dim):
        self.weight = jnp.ones((in_dim, out_dim))
        self.bias = jnp.ones((1, out_dim))


@pytc.treeclass
class Repr3:
    l1: Linear = dataclasses.field(repr=False)

    def __init__(self, in_dim, out_dim):
        self.l1 = Linear(in_dim=in_dim, out_dim=128)
        self.l2 = Linear(in_dim=128, out_dim=128)
        self.l3 = Linear(in_dim=128, out_dim=out_dim)


r1 = Repr1()
r2 = Repr2()
r3 = Repr3(in_dim=128, out_dim=10)

r1f = pytc.tree_filter(r1)
r2f = pytc.tree_filter(r2, where=lambda _: True)


def test_repr():
    assert (
        pytc.tree_unfilter(pytc.tree_filter(r1)).__repr__()
        == r1.__repr__()
        # trunk-ignore(flake8/E501)
        == "Repr1(\n  a=1,\n  b='string',\n  c=1.0,\n  d='aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',\n  e=[\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10\n  ],\n  f={1,2,3},\n  g={\n    a:'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',\n    b:'bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb',\n    c:f32[5,5]\n  },\n  h=f32[5,1],\n  i=f32[1,6],\n  j=f32[1,1,4,5]\n)"
    )
    assert r2.__repr__() == "Repr2(a=f32[5,1],b=f32[1,1],c=f32[1,1,4,5])"
    assert (
        r3.__repr__()
        # trunk-ignore(flake8/E501)
        == "Repr3(\n  l2=Linear(weight=f32[128,128],bias=f32[1,128],*notes='string'),\n  l3=Linear(weight=f32[128,10],bias=f32[1,10],*notes='string')\n)"
    )

    assert (
        r1f.__repr__()
        # trunk-ignore(flake8/E501)
        == "Repr1(\n  #a=1,\n  #b='string',\n  c=1.0,\n  #d='aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',\n  #e=[\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10\n  ],\n  #f={1,2,3},\n  #g={\n    a:'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',\n    b:'bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb',\n    c:f32[5,5]\n  },\n  h=f32[5,1],\n  i=f32[1,6],\n  j=f32[1,1,4,5]\n)"
    )


def test_str():
    assert (
        r1.__str__()
        # trunk-ignore(flake8/E501)
        == "Repr1(\n  a=1,\n  b=string,\n  c=1.0,\n  d=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa,\n  e=[\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10,\n    10\n  ],\n  f={1,2,3},\n  g=\n    {\n      a:aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa,\n      b:bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb,\n      c:\n      [[1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]]\n    },\n  h=\n    [[1.]\n     [1.]\n     [1.]\n     [1.]\n     [1.]],\n  i=[[1. 1. 1. 1. 1. 1.]],\n  j=\n    [[[[1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]]]]\n)"
    )
    assert (
        r2.__str__()
        # trunk-ignore(flake8/E501)
        == "Repr2(\n  a=\n    [[1.]\n     [1.]\n     [1.]\n     [1.]\n     [1.]],\n  b=[[1.]],\n  c=\n    [[[[1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]\n       [1. 1. 1. 1. 1.]]]]\n)"
    )
    assert (
        r3.__str__()
        # trunk-ignore(flake8/E501)
        == "Repr3(\n  l2=Linear(\n    weight=\n      [[1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]\n       ...\n       [1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]],\n    bias=\n      [[1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.\n        1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.\n        1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.\n        1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.\n        1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.\n        1. 1. 1. 1. 1. 1. 1. 1.]],\n    *notes=string\n  ),\n  l3=Linear(\n    weight=\n      [[1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]\n       ...\n       [1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]\n       [1. 1. 1. ... 1. 1. 1.]],\n    bias=[[1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]],\n    *notes=string\n  )\n)"
    )

def test_tree_summary():
    assert tree_viz.tree_summary(r2) == '┌────┬───────────┬───────┬─────────────┬─────────────────────────────────────────┐\n│Name│Type       │Param #│Size         │Config                                   │\n├────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤\n│a   │DeviceArray│5(0)   │20.00B(0.00B)│a=f32[5,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │\n├────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤\n│b   │DeviceArray│1(0)   │4.00B(0.00B) │b=f32[1,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │\n├────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤\n│c   │DeviceArray│20(0)  │80.00B(0.00B)│c=f32[1,1,4,5]∈[1.00,1.00]<μ=1.00,σ=0.00>│\n└────┴───────────┴───────┴─────────────┴─────────────────────────────────────────┘\nTotal count:\t26(0)\nTrainable count:26(0)\nFrozen count:\t0(0)\n----------------------------------------------------------------------------------\nTotal size:\t104.00B(0.00B)\nTrainable size:\t104.00B(0.00B)\nFrozen size:\t0.00B(0.00B)\n=================================================================================='
    # ┌────┬───────────┬───────┬─────────────┬─────────────────────────────────────────┐
    # │Name│Type       │Param #│Size         │Config                                   │
    # ├────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤
    # │a   │DeviceArray│5(0)   │20.00B(0.00B)│a=f32[5,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │
    # ├────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤
    # │b   │DeviceArray│1(0)   │4.00B(0.00B) │b=f32[1,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │
    # ├────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤
    # │c   │DeviceArray│20(0)  │80.00B(0.00B)│c=f32[1,1,4,5]∈[1.00,1.00]<μ=1.00,σ=0.00>│
    # └────┴───────────┴───────┴─────────────┴─────────────────────────────────────────┘
    # Total count:	26(0)
    # Trainable count:26(0)
    # Frozen count:	0(0)
    # ----------------------------------------------------------------------------------
    # Total size:	104.00B(0.00B)
    # Trainable size:	104.00B(0.00B)
    # Frozen size:	0.00B(0.00B)
    # ==================================================================================

    assert tree_viz.tree_summary(r2f) == '┌─────────┬───────────┬───────┬─────────────┬─────────────────────────────────────────┐\n│Name     │Type       │Param #│Size         │Config                                   │\n├─────────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤\n│a(frozen)│DeviceArray│5(0)   │20.00B(0.00B)│a=f32[5,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │\n├─────────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤\n│b(frozen)│DeviceArray│1(0)   │4.00B(0.00B) │b=f32[1,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │\n├─────────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤\n│c(frozen)│DeviceArray│20(0)  │80.00B(0.00B)│c=f32[1,1,4,5]∈[1.00,1.00]<μ=1.00,σ=0.00>│\n└─────────┴───────────┴───────┴─────────────┴─────────────────────────────────────────┘\nTotal count:\t26(0)\nTrainable count:0(0)\nFrozen count:\t26(0)\n---------------------------------------------------------------------------------------\nTotal size:\t104.00B(0.00B)\nTrainable size:\t0.00B(0.00B)\nFrozen size:\t104.00B(0.00B)\n======================================================================================='
    # ┌─────────┬───────────┬───────┬─────────────┬─────────────────────────────────────────┐
    # │Name     │Type       │Param #│Size         │Config                                   │
    # ├─────────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤
    # │a(frozen)│DeviceArray│5(0)   │20.00B(0.00B)│a=f32[5,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │
    # ├─────────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤
    # │b(frozen)│DeviceArray│1(0)   │4.00B(0.00B) │b=f32[1,1]∈[1.00,1.00]<μ=1.00,σ=0.00>    │
    # ├─────────┼───────────┼───────┼─────────────┼─────────────────────────────────────────┤
    # │c(frozen)│DeviceArray│20(0)  │80.00B(0.00B)│c=f32[1,1,4,5]∈[1.00,1.00]<μ=1.00,σ=0.00>│
    # └─────────┴───────────┴───────┴─────────────┴─────────────────────────────────────────┘
    # Total count:	26(0)
    # Trainable count:0(0)
    # Frozen count:	26(0)
    # ---------------------------------------------------------------------------------------
    # Total size:	104.00B(0.00B)
    # Trainable size:	0.00B(0.00B)
    # Frozen size:	104.00B(0.00B)
    # =======================================================================================

    assert tree_viz.tree_summary(r3) == '┌────┬──────┬─────────┬──────────────┬──────────────────────────────────────────────┐\n│Name│Type  │Param #  │Size          │Config                                        │\n├────┼──────┼─────────┼──────────────┼──────────────────────────────────────────────┤\n│l2  │Linear│16,512(0)│64.50KB(0.00B)│weight=f32[128,128]∈[1.00,1.00]<μ=1.00,σ=0.00>│\n│    │      │         │              │bias=f32[1,128]∈[1.00,1.00]<μ=1.00,σ=0.00>    │\n├────┼──────┼─────────┼──────────────┼──────────────────────────────────────────────┤\n│l3  │Linear│1,290(0) │5.04KB(0.00B) │weight=f32[128,10]∈[1.00,1.00]<μ=1.00,σ=0.00> │\n│    │      │         │              │bias=f32[1,10]∈[1.00,1.00]<μ=1.00,σ=0.00>     │\n└────┴──────┴─────────┴──────────────┴──────────────────────────────────────────────┘\nTotal count:\t53,406(0)\nTrainable count:53,406(0)\nFrozen count:\t0(0)\n-------------------------------------------------------------------------------------\nTotal size:\t208.62KB(0.00B)\nTrainable size:\t208.62KB(0.00B)\nFrozen size:\t0.00B(0.00B)\n====================================================================================='
    # ┌────┬──────┬─────────┬──────────────┬──────────────────────────────────────────────┐
    # │Name│Type  │Param #  │Size          │Config                                        │
    # ├────┼──────┼─────────┼──────────────┼──────────────────────────────────────────────┤
    # │l2  │Linear│16,512(0)│64.50KB(0.00B)│weight=f32[128,128]∈[1.00,1.00]<μ=1.00,σ=0.00>│
    # │    │      │         │              │bias=f32[1,128]∈[1.00,1.00]<μ=1.00,σ=0.00>    │
    # ├────┼──────┼─────────┼──────────────┼──────────────────────────────────────────────┤
    # │l3  │Linear│1,290(0) │5.04KB(0.00B) │weight=f32[128,10]∈[1.00,1.00]<μ=1.00,σ=0.00> │
    # │    │      │         │              │bias=f32[1,10]∈[1.00,1.00]<μ=1.00,σ=0.00>     │
    # └────┴──────┴─────────┴──────────────┴──────────────────────────────────────────────┘
    # Total count:	53,406(0)
    # Trainable count:53,406(0)
    # Frozen count:	0(0)
    # -------------------------------------------------------------------------------------
    # Total size:	208.62KB(0.00B)
    # Trainable size:	208.62KB(0.00B)
    # Frozen size:	0.00B(0.00B)
    # =====================================================================================